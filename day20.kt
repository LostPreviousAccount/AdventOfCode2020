//Kotlin 1.1
// https://play.kotlin

fun main(args: Array<String>) {
    var ex1="""Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###..."""
    
    val input = """Tile 1409:
##..#.#.#.
##........
#.#...##.#
#..#..#...
.......##.
##......##
..........
.........#
.#..##....
#.##...##.

Tile 2939:
......#.##
##.#......
...##...##
#.#.....##
#...#....#
.#..#....#
#.....##.#
..##.#...#
..#.#.#..#
#######..#

Tile 3347:
...##..#.#
.#......#.
.#........
#.....#...
#.....##..
##.......#
.....#....
......###.
#...#..##.
########.#

Tile 1297:
#..#.##.##
#..###...#
#.##......
...#.#...#
#.#......#
....#....#
.#..#.....
......##..
#.........
...#.##.##

Tile 3203:
####.#.#..
#.#.#.##..
#......###
#....###.#
.......#.#
#.........
#..#..##..
..##...#.#
#.....##..
#.##.#...#

Tile 1283:
####..#...
#.......##
#....#..#.
..##.....#
.#...#####
###...#...
..##....#.
.#.......#
.##.#.....
#.###..###

Tile 1879:
######.#..
..#.#....#
..#..##...
.#...#.#..
....#....#
....#.#.##
##.......#
#...#..#.#
..#.##....
#..####.#.

Tile 2293:
#.##.###.#
..#.....##
#...#.....
..##......
.#...#.#.#
#........#
.##...###.
###.#....#
...#......
.#..######

Tile 3079:
#.###.....
......#...
..##......
..#...#...
.#.#......
#....#...#
........##
..#..#...#
#..#......
#.#.#.###.

Tile 1069:
.#.##.....
...##...#.
###.#..##.
.#....#.##
......#.#.
#.#..#.##.
...#......
#..##...#.
##.##.....
#.#.##.#..

Tile 1229:
#.#...#..#
.........#
....#..##.
#.#...#..#
...###.#.#
##.##.....
...##....#
..#..#.###
..#......#
.##..#.#.#

Tile 3631:
###.....##
#.#.......
#.#.#..#.#
....#...##
#.###.#.#.
.....##.##
...#..###.
#..#...#.#
..#..##..#
.##.#.#..#

Tile 1747:
..##.....#
.#.....#.#
..........
..#.#.#..#
#...#.....
..##.#.#..
#....#..##
...#.....#
#.....##.#
..#.#####.

Tile 2531:
.#...##...
#....####.
##...##..#
#..#...#..
##....#...
.#....#.##
.........#
.#......#.
...#...#.#
##....#...

Tile 2203:
##..#...##
##..#.#..#
....##..#.
###.###...
.......#.#
#.....##.#
#.#....#..
.......#.#
...#.#....
##.#.####.

Tile 2777:
...#.##...
...#......
.#....##..
....#..#.#
#.....#..#
......##..
#....##.##
......#..#
#..##.##..
...#.#.###

Tile 3323:
#...##.#.#
..#.......
#......#..
.#..##...#
......##..
#....#..##
.......#.#
....#...#.
#.....#...
##..#.#..#

Tile 3319:
#....#.##.
##.....#.#
####......
..#.##..##
##....##.#
.......#.#
..######.#
#.#......#
#..#......
#..#.#..##

Tile 3313:
...#.##.##
........##
##..#...##
##.....#.#
##..#....#
.......#..
##.......#
#.#.......
.........#
#.#..###.#

Tile 2657:
.###..#..#
..#......#
.#...##...
#..#.....#
....#...##
#.........
...##.#...
.##....#.#
##...#....
#.####...#

Tile 1907:
#.#####.#.
##..#.##..
.....#.###
.#.#..##.#
.#.###...#
...####...
#..###....
##....#...
..#..#.#..
#...###.#.

Tile 3373:
#.#####...
..###.....
.##..#..##
....#...##
......#..#
..##.....#
....##.###
.#.#.....#
#..##.#...
.......###

Tile 3253:
##..###..#
##......##
##.......#
##.#......
##.......#
#........#
..##...###
#..###..#.
#.....###.
..#.##..##

Tile 2767:
......####
..#...####
..###.....
#...##...#
...#..#..#
.####....#
#...##...#
...##.####
#...##.#..
..#.....##

Tile 3761:
....######
.......###
.#.##.....
.......#..
..........
.#.#.....#
#........#
##.##...##
#......#.#
#.##.#..#.

Tile 1031:
...#.###.#
.#......#.
##...#..#.
#...#.....
#.....#.##
#.#...#..#
##..##.#..
.##.#..#..
..#.....##
.......#.#

Tile 1181:
####..#.##
.....###.#
..##..#...
...#.#..##
...#....#.
#.......##
...#....##
#..##.#..#
###...#...
#.##..#.#.

Tile 2887:
.####..#.#
.......#.#
#.#..#.#.#
#.##.....#
...#.#...#
###..#....
#...#.....
.....#....
###..#..#.
...###..#.

Tile 1381:
#...#..#.#
..........
....#...#.
..#..##...
........##
#.#.......
##........
.#..##...#
#..#......
########..

Tile 2621:
...#.####.
#...#..#..
#.#.....#.
..##.#..##
####..#...
.###.#..#.
##...##..#
#..#.#..#.
#..##.#...
#..###...#

Tile 1597:
##.##..###
.#...##...
..##....#.
.##.......
.##....#.#
#..#.#....
#........#
...#......
.#..###.##
...###.###

Tile 3533:
#.###.##.#
##.##...#.
##..#.#.##
.#.#..#.##
#.....#...
#..#...#.#
..###.#..#
.#....#.#.
#.........
#...#.#.##

Tile 1249:
.##.....##
#.....#.##
#..#..#.##
#.#.#...#.
......#...
.#...##...
##.#.....#
..###.....
#.......#.
#.######..

Tile 2843:
#.#.#.....
.......#.#
#.....###.
#.....##.#
...##.##.#
#...#.####
..#.#....#
.......#..
##.#..#.##
.##.##...#

Tile 1583:
..####.#..
##..#....#
###...##.#
#....#.##.
#..#......
##.......#
##.#...#..
....#.#..#
....#..#.#
....#.###.

Tile 3169:
...#.###..
.####.....
#.#.#..#..
#...#..#..
..........
##.#...#..
..........
#..#....##
#...#....#
..##.....#

Tile 1367:
......##..
.##.......
##.#..##.#
#...#.#...
#.###.#..#
#.#...#..#
.....#...#
.....#...#
#.#.#.#...
#....##...

Tile 2099:
..###.####
.####.###.
...#...#..
...##.##.#
#....##...
....#..#.#
...#...##.
#........#
#..#.#..#.
..##...##.

Tile 3613:
#.#.####..
###......#
.##..##...
##..##...#
#........#
.....#....
.......#..
.##.#.....
.##.#....#
####..#.##

Tile 3727:
..#.##.##.
#..#..##..
##........
#.......#.
.#.###.#..
.#....#...
#.........
#...#.#.#.
.#..#...##
.###.#.#..

Tile 3697:
##.###.#..
......####
#...#.#...
.###...#.#
##.#....#.
..##.#..#.
.##....#.#
#..#.....#
.#........
#######.#.

Tile 2503:
..#.#..#..
.......###
....#.....
####.#.##.
...##...#.
#..#..#..#
..........
.......#..
##..#..#.#
.#...#.###

Tile 2131:
##..#...##
#..#.#..##
..##...##.
.....#.#.#
...##....#
..##..#..#
..........
......#.#.
.#..#.#.##
#..##.##..

Tile 2129:
.#.#....#.
.......#.#
.....#..#.
.#......#.
###.#.#...
##.##.#...
...#.##...
......####
....#####.
#..#.##.#.

Tile 3643:
##..#.....
.##.##...#
#....#...#
#.###.....
####.#....
.#.....#..
##..###.#.
..#..#.#.#
#..##.#..#
#...##..##

Tile 1307:
#......#.#
##...#..#.
......##..
....#.#..#
#....##..#
......#.##
....#.#..#
#....#....
#..#..#...
#..#.#.#..

Tile 3989:
..###.#..#
###...#...
..#..#....
##....#.#.
##..#.#..#
.......##.
...#..##.#
#....#....
......#...
####.#..#.

Tile 2347:
.#########
##...#.#.#
..#.##...#
#..#..##..
#..#......
###......#
.##...#...
.####...#.
#...#.##..
.#.#####..

Tile 2801:
#.###.####
......#..#
...##.....
#.....#..#
...#......
........##
..###.####
#.#.#.##..
###...##..
##.##..##.

Tile 2543:
.....#..##
#....#.#..
....#.##.#
##.#..###.
.#.#.#..##
#.###.#..#
##..#..#.#
...###.#..
.....###.#
.##..#.#.#

Tile 2029:
##.##..###
.........#
#.#......#
#.#.#..#.#
.#.#.##.##
#.....####
...#.#....
#..##....#
....#.#...
###.#..###

Tile 1889:
#..#.#####
#.#.#...##
#.#...##.#
.....#...#
##...#.###
.....#....
#.#......#
#........#
...#......
.#..#####.

Tile 1787:
######.#.#
#.........
.#.#.#....
...#.....#
#..#.#..##
##.#...#..
...#.....#
##..#.#...
#.....##..
#...##.###

Tile 1619:
#.####....
#.#.#.##..
#...#....#
.#........
.......#..
#....#.#.#
.......#.#
.#.#..##.#
.##..##.#.
.#...##...

Tile 2617:
#..##.###.
.###...#..
..#.....#.
#....##...
#...#...##
.#.....#.#
#....#...#
...##..#.#
........##
...###...#

Tile 2879:
#.#.####..
.....#....
.###...#..
...#......
#.#.....#.
....#.....
.#.#.#.#.#
......#.#.
#.........
#.#..#####

Tile 1429:
..#.......
#.##.#.###
#......###
....#...#.
.....#.#.#
..#....###
#..#......
....#..#..
..#...#...
.#####.#..

Tile 2797:
##.#.#..#.
.....#.#.#
.......#.#
#...#.#...
.##.#.##.#
.##.....##
##......#.
##.#.#.#..
.....#...#
##.#######

Tile 3943:
..#.#.####
.#.......#
#..#.##.#.
.#..#....#
.#.##....#
#.#.#.#..#
......#...
#...##...#
#....##...
.##....#.#

Tile 3691:
##.#...###
.#.##...#.
##.##....#
.##.......
......#..#
...#..#..#
####.....#
#..####...
..#.....#.
...#.#....

Tile 3083:
#.###.....
#.#....#.#
#..#...###
...#..#..#
..#..#....
##...#.#.#
#.#.......
#.#..###..
##.#.....#
.#.##.....

Tile 1013:
#....#..##
#..#....##
#.#.#.#...
.....#.#.#
#........#
..#.....#.
.##..#.###
#..#..#.#.
........##
#.#.#.#.##

Tile 2089:
##.#.#..#.
#...#...##
#...#...##
..#....###
...#......
......##..
#......###
...#...###
.##...#.#.
.##...###.

Tile 2551:
###.######
####.#.###
.##.##...#
#..##.##.#
#.#.#.#..#
....#.#...
#.#....#..
##...#...#
#..#.#...#
..###..#.#

Tile 3607:
.#...##..#
####......
#..#.##..#
#..#......
###.....#.
#....###..
.........#
....##.#.#
......#..#
...#####..

Tile 1831:
##....##..
##.#......
#.#....#..
#.##..##..
...###....
##.#.#...#
#...#.#...
....#....#
##......##
.##.#..#.#

Tile 1697:
##..###.#.
#..#...###
#..#.....#
......#...
...#......
#........#
.#....####
#....#....
..##.###..
.#.##..#..

Tile 1621:
....##.##.
....#.#...
....#.#.#.
#.#...#..#
..#..#.#..
#........#
....##....
#.###.#..#
#....#..##
#..####...

Tile 1019:
.#.###..#.
###.......
#...#.#..#
..#.#.....
#.....###.
....#..#.#
.#.#.#.#..
#.........
#...#..#.#
..##..####

Tile 1471:
...#.####.
...##.##..
#.#.#..###
..##...###
##.###....
#....#...#
........##
#.##....#.
##.##..#.#
####.###..

Tile 3797:
..##...##.
#...#....#
###.###.##
##....##..
#.#.#...##
....##....
#.....#..#
#...#.#...
#.##.#..#.
..#.#.#.#.

Tile 1231:
##....#..#
#.........
#..#.#....
##...#....
#..#.#...#
###.##....
##.#....#.
....#.#..#
.#...#..##
#..#####.#

Tile 1667:
##.##.#..#
...#..#.##
..........
#.........
..#.##...#
....#.#.##
..#.##...#
##...###.#
###.......
#####..###

Tile 3719:
..##.##..#
...#......
#......#.#
#.#..###..
....#.#.#.
#.........
#........#
##.......#
#.....#..#
.##.#.####

Tile 1103:
.#..####.#
#....##.##
....###..#
#.........
#..#.....#
#......#..
.#..###.#.
.....#....
.......#.#
.##.##.###

Tile 2609:
..####..#.
#.....#..#
.#.####...
....#.....
#......#.#
.........#
.......#..
#.##.#....
..#.#.....
####.##..#

Tile 1117:
.#.#..##.#
#...#....#
#.#..####.
.#.......#
#...#.....
#...#....#
#..#.#.#..
.........#
.....#.##.
.#..####.#

Tile 3359:
##...#.#.#
..#.#....#
..#..##...
.......#..
.........#
#.#...###.
..#..#...#
#..#.....#
#..#.#..##
.###.#.#.#

Tile 2851:
.#....####
#...##...#
#..#.....#
#......#..
#.......#.
.###.#.#..
#....#..#.
###......#
#.##.#..#.
..#...#.##

Tile 2423:
.#..#.####
...#....#.
.....##...
.........#
........##
##.......#
........#.
#....#..##
#.#.......
#...##.##.

Tile 1579:
.##....#.#
##...#....
.#.##....#
..##.#.###
.#..#.#..#
....##..#.
..#..##..#
#.#..##...
.........#
.#.###.###

Tile 1361:
....#..##.
.###.#...#
...#.#....
#..#..#...
#.##......
#..#...#..
.##......#
.#...#.#.#
#........#
.#.#######

Tile 1171:
##.####..#
....#.#..#
#..#.....#
#.#......#
###...#..#
.##.#...##
##..##.#.#
#..#.#..##
#......#.#
....#.###.

Tile 3847:
##...#..#.
##.#.#..##
..........
#........#
..........
#........#
#..#.#....
.#.....#.#
....#.....
#.##.##.##

Tile 2557:
##..#.#...
.#.#..#...
####....#.
#...#.#...
...#.....#
..#..##..#
..###.#.##
...#..#..#
.....##...
##.####..#

Tile 2069:
..###....#
###..#.###
........##
#..#.#..#.
.........#
##.#.#.#.#
....#...#.
...#.#....
........#.
#.#.##..##

Tile 2179:
##...#.#.#
.##..#.##.
#..#..#...
..........
###.#....#
..........
#...#.....
#........#
....#...#.
##..####..

Tile 2659:
##..#...#.
#....##...
.....#.#.#
.......#..
##.#..#.#.
##........
#....###.#
#......#.#
.........#
#...#.##.#

Tile 1097:
.#..#.###.
.....#..##
....####..
.#.#.....#
......##.#
.#..####.#
.###....#.
..##.##...
###.##.#..
#..###...#

Tile 2143:
.##.....#.
......#..#
.#........
##......##
###....##.
#...#....#
..#..#..##
..##....#.
#.#.......
#..#####.#

Tile 3527:
##.#...#..
..#.###..#
.........#
.....##.##
.#.....###
#.#...#..#
.#.##.#.##
###.#..#..
.........#
#####.#.##

Tile 1063:
##.#.#.##.
##...#....
#.........
##..#.#..#
......##.#
##....#.#.
.....#..##
##.###...#
.....##.#.
#......#.#

Tile 2593:
#...####.#
##.####...
##.#.#..#.
#........#
#...#....#
.........#
.#..#..#.#
......#...
.#.......#
##..#####.

Tile 1753:
...#.#..#.
#.....#...
.#......##
.#....##.#
.#..#...##
..#..###..
###......#
#.#.#..###
###....##.
..#.##...#

Tile 2273:
#..##.###.
#.....#...
#...##....
..#....###
#.........
#####.#...
##..###..#
#...##....
#.#......#
##.##..##.

Tile 2731:
.#..#..##.
...#...#.#
...##.....
#..#..#..#
..........
.......###
...#..####
##.##....#
...#.#..#.
.##..#..##

Tile 2477:
..#.###.##
#..#.#....
.#.....#..
##..#.##..
...##....#
#.#.#...##
.##......#
..##..#..#
..#......#
#..#..#.##

Tile 2243:
.#..######
..#..####.
...##.#...
...##..#.#
..#.#...#.
#.#.#..#..
..#......#
#...#.#...
...##...##
##.#####.#

Tile 1451:
#.####.#.#
#........#
#.#......#
.#.......#
.........#
..........
#.........
.........#
#.........
..#..#..##

Tile 1289:
#....#...#
#.....#.#.
...#......
.#....###.
......#..#
##........
###.......
.#...#..#.
..#..#.#.#
#.#...###.

Tile 2927:
..##.#..#.
##.#.#..#.
..########
#....##...
...#.##...
#.........
#.....#.#.
#.##..#...
....#.#...
#.##.#..##

Tile 3433:
#.##...###
#.#..#..#.
.#.....#.#
#..#......
.....##...
#.##.....#
#..#....##
.....#..##
##..#.....
..###..###

Tile 1913:
#.##..#.##
#..####.#.
#.##..##..
....#..#..
.#.....#..
.#..#....#
#..####.##
..#..#...#
#.......##
.#.#####..

Tile 1567:
####...##.
#..#.....#
##..#...#.
##.#.#.#.#
..#.#.#...
##.#..#..#
.##...##.#
....#...#.
..###..#..
...#..####

Tile 2707:
.#.#.#..##
.#....#..#
#..#.#...#
......#.#.
.#..##...#
.#.##.....
#.#.....##
#.....#..#
#..#..##.#
#..#...#.#

Tile 3803:
#..#.#...#
.#........
##....###.
#.##....##
..#....#..
##.#..#.#.
....#..#.#
.#.......#
#..#...#.#
##.....###

Tile 2837:
.#..#####.
#.......##
###..#.###
#...#....#
..#..#.#..
....#....#
.#..##.##.
...#.....#
#...#..#.#
.##...##.#

Tile 2473:
#.##..##..
....#..#.#
.........#
#.....##..
....#.#..#
...#..#...
....#...##
.....###..
..#......#
##..###..#

Tile 3121:
...#.##..#
#........#
.##..##...
#.....#..#
......##.#
......#.#.
......#..#
........##
#...#....#
.##.#..#..

Tile 1637:
#....#....
....#..#..
#......#.#
#..#..#..#
#.......##
#..##.....
#....#...#
.#........
.##..##.##
.##...###.

Tile 1091:
..###....#
###...#...
..#......#
##........
.........#
.....##..#
###.##....
#..#....#.
.#.#.#....
.....#####

Tile 1453:
###...#.##
.##..#.#.#
.#.......#
.##...#..#
#..#...#..
.##...#..#
#....##..#
...##..#..
....#.....
..##....##

Tile 2861:
##....####
.....#...#
.##.#...#.
.....##..#
##..##..#.
#...#.##.#
##....##.#
#..#.#....
#####.#...
##.....#..

Tile 2677:
##..#..#.#
#....#....
.#..#....#
.###....#.
.#........
.....#.#.#
#..#.....#
#.##.##.##
..#.##..##
#..#..#...

Tile 3413:
..###.#..#
...##.....
...#..####
........#.
##.....#.#
......#..#
#...#..#.#
#.......#.
##..#.#.#.
#...#####.

Tile 1193:
#.#.#.#.#.
.#....##..
#.........
.......#.#
..#.#.#.##
...#...##.
##........
#..#....##
.........#
####...###

Tile 1949:
##..#..##.
.....#..#.
...##...##
####....##
.#..#.....
#........#
.##.#....#
...##.....
...#..####
###...####

Tile 3863:
#.#..#.###
#.#.....##
##....##.#
..###.###.
#.##....#.
...#.#.###
...#..#.##
..#......#
##...#...#
#..#.#.##.

Tile 1439:
#....#.###
.....#.#.#
.#.#...##.
.##.#....#
#....#....
....#.#..#
.....#...#
#...###...
.#..##..##
##..#.####

Tile 1129:
..########
..#.#.#...
....##....
.......#..
........##
..........
#..#.#.#..
##........
.........#
..##..####

Tile 2953:
.#.###.###
........#.
....#.#.##
..#.#....#
......#.##
...#....#.
###...#..#
....#.....
#.........
#...#...#.

Tile 3371:
##..#..###
##.....###
##....#..#
#.....#...
###.#..###
.#.#..#.##
##........
##.......#
#.##..#...
..##.####.

Tile 1399:
#.....#.#.
#......#..
.#..#....#
####..#..#
#..#.....#
##..#..#..
#.....#.##
.#..##..#.
.#..#....#
..#.#.###.

Tile 3911:
.#.....#.#
..#.....##
#...##....
#.........
..#.#...##
..#...#..#
.#.#....##
#..##....#
.#..##..##
#.#..#..#.

Tile 1699:
.####.####
..#..#....
#.....#.#.
...#..##..
##.#..#...
##..##....
#..#..#.#.
.###.#....
.....##.##
.#..#...##

Tile 3701:
.#.#.#.#..
..#.####.#
..##...###
......##.#
....#....#
.....#..##
...#.#.###
#..####.#.
...##....#
..###..###

Tile 1811:
.##.##.#..
....#....#
#......#.#
.....#..#.
#..#.#...#
.#.#.##..#
......#...
..##..#...
.....#...#
#####.#..#

Tile 2539:
...######.
#...#.###.
.#..#.....
.....#...#
.#...#...#
#.###..###
.######...
#...#.#.##
#.....##.#
...#..#.##

Tile 3517:
.#...#.##.
#....#..#.
#......#.#
##.##.....
...###..#.
#..#.#...#
#...#.#...
###.......
.#.......#
######.#..

Tile 2113:
#..###..#.
...#....##
##.......#
#....##..#
..#.#..###
#.#......#
#.....#..#
.#..#.#..#
...###....
##.#..#...

Tile 1009:
...##..###
..#.......
.#.....##.
##....#..#
##........
#....#..#.
.........#
#.#..#..##
....#.#..#
..#.##.#.#

Tile 1559:
###....#.#
.###...#.#
#.#.....#.
.#..#.#..#
....##.#.#
#.#..##.##
..#..##...
#.###.....
.#.#.##..#
##....####

Tile 2971:
...###...#
......##..
...#....##
.#.#.##..#
###.#.##.#
#..#...##.
..#.#...##
.....#.##.
.#........
##....#..#

Tile 1327:
.#..##...#
#.##.....#
.#.....#.#
...###...#
#....#....
.#.......#
.#.......#
#.........
.....#...#
..#######.

Tile 3217:
..###..#..
.#..#....#
......####
###....#.#
###...#...
.#...#....
........##
#.##.#.##.
#......#..
...#...#.#

Tile 1861:
####.####.
.#.....#..
###...#...
.##.#..##.
...#..#...
...#..#...
##..#...##
#...##..#.
#...#.....
##........

Tile 3593:
.##.##.###
....#...##
.#..#....#
#..##.##..
#..#...###
...#..##..
....#...##
###......#
..........
..#......#

Tile 3041:
###..###.#
....####..
....#..##.
#.#.....##
#..#...#..
#.......##
.#...#####
##.#...#.#
..#.###.#.
.####...##

Tile 2647:
#.###.####
#...#...##
.##....##.
#.#.#.....
#..#..##.#
##....#..#
..#....###
.....###..
........##
#.#.#....#

Tile 2437:
.##...#...
#.#...##.#
.#....##.#
#####...#.
#...##.#..
..#....#..
#.......#.
..#..#.#..
#.##...#.#
#.##..#..#

Tile 3709:
#######.##
###.#..##.
#.#...#..#
.#....####
##...#..#.
....#..#..
##........
#..##..#.#
.....#...#
..#.##...#

Tile 2039:
##.###..#.
...#.....#
..#...##.#
##.#.#...#
#....#..#.
#.####...#
...##...##
##...##..#
#.....##.#
####.#.#.#

Tile 3011:
...##.#...
.........#
###.####.#
#.......#.
.#.....#.#
..######..
#.....#..#
#........#
.##.##....
#.....###.

Tile 1151:
.##.#..#.#
#.##.....#
...#..#...
....##..##
###....###
##..#..#.#
#...#....#
..#....#..
...#.....#
#.#..#.#.."""
    
    //println(solution1(ex1))
    //println(solution1(input))        
    
    val image=""".#.#..#.##...#.##..#####
###....#.#....#..#......
##.##.###.#.#..######...
###.#####...#.#####.#..#
##.#....#.##.####...#.##
...########.#....#####.#
....#..#...##..#.#.###..
.####...#..#.....#......
#..#.##..#..###.#.##....
#.####..#.####.#.#.###..
###.#.#...#.######.#..##
#.####....##..########.#
##..##.#...#...#.#.#.#..
...#..#..#.#.##..###.###
.#.#....#.##.#...###.##.
###.#...#..#.##.######..
.#.#.###.##.##.#..#.##..
.####.###.#...###.#..#.#
..#.#..#..#.#.#.####.###
#..####...#.#.#.###.###.
#####..#####...###....##
#.##..#..#...#..####...#
.#.###..##..##..####.##.
...###...##...#...#..###"""
    //println(solution1(ex1))
    //println(solution2(ex1))
    println(solution2(input))
}

fun solution1(input: String): Long {
    val tiles: Map<String,List<String>> = input.split("\n\n").map { toTiles(it) }.toMap()    
    val cornerIiles = getCornerTiles(findCorrespondances(tiles))    
    return cornerIiles.reduce {acc,i -> acc*i}
}

fun getCornerTiles(corres: Map<String,Set<String>>) : List<Long> {
    return corres
        .filter { (_,kv) -> kv.size == 2 } //corners have only 2 possible attachs
        .keys
        .map { it.toLong() }
}

fun findCorrespondances(tiles: Map<String,List<String>>): Map<String,Set<String>> {
    return tiles.map {
        (k,v) -> k to v.flatMap { i ->
                    tiles
                        .filterKeys { kt -> kt!=k }
                        .filter { (_,kv) -> kv.contains(i) }
                        .keys
                }.toSet() // drop duplicate of matching tiles
    }.toMap()
}


fun toTiles(str : String): Pair<String,List<String>> {
    val lines = str.split("\n")
    var tile_nb = lines.get(0).split(" ").get(1)
    tile_nb = tile_nb.substring(0,tile_nb.length-1)
    val tile_data: List<String> = lines.drop(1);
    val borders = listOf(tile_data.first(), 
                         tile_data.last(),
                         tile_data.map {it.first()}.joinToString(separator=""),
                         tile_data.map {l->l.last()}.joinToString(separator=""))
                    .flatMap {listOf(it,it.reversed())} // combinations of borders with their flip value
    /*print(tile_nb)
    print(" : ")
    println(borders)*/
    return Pair(tile_nb, borders)
}

/**
 * 
 * PART2
 * 
 * */

fun tilesMap(input:String): Map<String,String> {
    fun toTileKeyPair(str:String) : Pair<String, String>{
         	val lines = str.split("\n")
	    	var tile_nb = lines.get(0).split(" ").get(1)
    		tile_nb = tile_nb.substring(0,tile_nb.length-1)
    		val tile_data = lines.drop(1).joinToString(separator="\n");
        	return tile_nb to tile_data
    	}
    return input.split("\n\n").map { toTileKeyPair(it) }.toMap()
} 

fun getRightBorder(tile:String):String {
    return tile.split("\n").map {it.last()}.joinToString(separator="")
}

fun getLeftBorder(tile:String):String {
    return tile.split("\n").map {it.first()}.joinToString(separator="")
}

fun getTopBorder(tile:String):String {
    return tile.split("\n").first()
}

fun getBottomBorder(tile:String):String {
    return tile.split("\n").last()
}

fun permuts(tile:String): List<String> {
    return listOf(tile, rotate90(tile), rotate90(rotate90(tile)), rotate90(rotate90(rotate90(tile))), flipV(tile), flipH(tile), rotate90(flipH(tile)), rotate90(flipV(tile)))
}

fun mergeCols(strs : Array<String>) : String {
    val lines = strs[0].split('\n').count()
    return (0..lines-1).map {l -> strs.map { it.split('\n').get(l)}.joinToString(separator="").filterIndexed { i,_ -> (i%10!=0 && i%10!=9) } }.joinToString(separator="\n")
}

fun dopuzzle(corr: Map<String,Set<String>>, tiles:Map<String,String>):String {
    //start with 3607
    var dispo = Array(12) {Array<String>(12){""}}
    var x = 0
    var y = 0
    var cols = Array<String>(12) {""}
    var currTileId = "3607"
    cols[y] = currTileId
    val mtiles = tiles.toMutableMap()
    val currTile = mtiles[currTileId]!!
    dispo[x][y] = currTile
    var border = getRightBorder(currTile)    
    var endofline = false
    // first line of image
    while (endofline == false) {
        var found :String? = null    
        var itera = corr[currTileId]!!.iterator()
        var acorrId = ""
        
        while (found == null && itera.hasNext()) {
            acorrId = itera.next()
            found = permuts(tiles[acorrId]!!).find { p -> getLeftBorder(p) == border}
        }
        if (found != null) {
            y++
            cols[y] = acorrId
            dispo[x][y] = found
            currTileId = acorrId
            border = getRightBorder(found)
            mtiles[currTileId] = found
        } else { // no right matching found
            endofline = true
        }
    }
    // now do it by col    
    y = 0  
    while (y < 12) {
        endofline = false
        x = 0
        currTileId = cols[y]
        var border = getBottomBorder(mtiles[currTileId]!!)
        while (endofline == false) {
            var found :String? = null    
            var itera = corr[currTileId]!!.iterator()
            var acorrId = ""
            
            while (found == null && itera.hasNext()) {
                acorrId = itera.next()
                found = permuts(tiles[acorrId]!!).find { p -> getTopBorder(p) == border}
            }
            if (found != null) {
                x++
                dispo[x][y] = found
                currTileId = acorrId
                border = getBottomBorder(found)
                mtiles[currTileId] = found
            } else { // no bottom matching found
                endofline = true
            }
        }
        y++
    }
    val image = dispo.map { mergeCols(it) }.joinToString(separator="\n")
        	.split('\n').filterIndexed { i,_ -> (i%10!=0 && i%10!=9) }.joinToString(separator="\n")
    return image
}
 
fun solution2(str:String):Int {
    val tilesBorders = str.split("\n\n").map { toTiles(it) }.toMap()
    val co = findCorrespondances(tilesBorders)
    val image = dopuzzle(findCorrespondances(tilesBorders), tilesMap(str))
    // image is here !
    val pattern = monsterPattern()   
    var img = image
    var count = 0
    while (count == 0) {
        count = findMob(pattern, img)
        if (count == 0) {
            println("flipH")
            count = findMob(pattern, flipH(img))
        }
        if (count == 0) {
            println("flipV")
            count = findMob(pattern, flipV(img))
        }
        if (count == 0) {
            println("rotate90")
        	img = rotate90(img)
        }
    }
    return img.filter {c -> c =='#'}.count() - (count * pattern.size)
}
 
fun monsterPattern():List<Pair<Int,Int>> {
    val mob ="""                  # 
#    ##    ##    ###
 #  #  #  #  #  #   """
    return mob.split("\n").flatMapIndexed { il,el ->
        el.mapIndexedNotNull { i,e -> if (e=='#') il to i else null}
    }
}

fun checkMob(startx:Int, starty:Int, lines: List<String>, pattern:List<Pair<Int,Int>>): Boolean {
    return pattern.all { x -> lines.get(x.first+startx).get(x.second+starty) == '#' }
}

fun findMob(pattern:List<Pair<Int,Int>>, image:String):Int {
    val lines = image.split("\n")
    val pattern_h = pattern.map {kv -> kv.first}.max()!! // height of pattern
    val pattern_w = pattern.map {kv -> kv.second}.max()!! // width of pattern
    val maxj = lines.get(0).length - pattern_w
    var ijs = mutableListOf<Pair<Int,Int>>()
    for (i in 0..lines.size - pattern_h) {
        for (j in 0..maxj) {
            if (checkMob(i,j, lines, pattern)) ijs.add(i to j)
        }
	}
    return ijs.size
}

fun rotate90(image:String):String { //rotate inverse clock
    val lines = image.split("\n")
    val maxj = lines.get(0).length -1
    return (maxj downTo 0)
        .map {j -> lines
                	.map { it.get(j) }
                	.joinToString(separator="")
		}
    	.joinToString(separator="\n")
}

fun flipH(image:String):String {
    return image.split("\n")
    	.map {l -> l.reversed()}
        .joinToString(separator="\n")
}

fun flipV(image:String):String {
    return image.split("\n")
    	.reversed()
    	.joinToString(separator="\n")
}
